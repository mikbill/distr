#!/bin/bash
download_mikbill (){
rm -Rf $dir_download/mikbill
wget -P $dir_download/mikbill https://github.com/mikbill/distr/raw/master/mikbill/crontab \
                              https://raw.githubusercontent.com/mikbill/distr/master/mikbill/www.conf
wget -P $dir_download/mikbill/www https://github.com/mikbill/distr/raw/master/host/admin.tar.gz https://github.com/mikbill/distr/raw/master/host/map.tar.gz https://github.com/mikbill/distr/raw/master/host/stat.tar.gz
}

download_radius (){
rm -Rf $dir_download/radius
wget -P $dir_download/radius   https://github.com/mikbill/distr/raw/master/mikbill/radiusd.conf \
                              https://github.com/mikbill/distr/raw/master/mikbill/sql.conf
wget -P $dir_download/radius/dictionary  https://github.com/mikbill/distr/raw/master/mikbill/dictonary/dictionary \
                                        https://github.com/mikbill/distr/raw/master/mikbill/dictonary/dictionary.dhcp \
                                        https://github.com/mikbill/distr/raw/master/mikbill/dictonary/dictionary.dlink \
                                        https://github.com/mikbill/distr/raw/master/mikbill/dictonary/dictionary.mikrotik \
                                        https://github.com/mikbill/distr/raw/master/mikbill/dictonary/dictionary.mpd
}

download_nginx (){
rm -Rf $dir_download/nginx
wget -P $dir_download/nginx https://raw.githubusercontent.com/mikbill/distr/master/nginx/nginx.conf
wget -P $dir_download/nginx/vhosts https://raw.githubusercontent.com/mikbill/distr/master/nginx/conf.d/00_stat_zaglushka_vhost.conf \
                                  https://raw.githubusercontent.com/mikbill/distr/master/nginx/conf.d/admin_vhost.conf \
                                  https://raw.githubusercontent.com/mikbill/distr/master/nginx/conf.d/map_vhost.conf \
                                  https://raw.githubusercontent.com/mikbill/distr/master/nginx/conf.d/stat_vhost.conf
wget -P $dir_download/nginx/vhosts/ssl https://raw.githubusercontent.com/mikbill/distr/master/nginx/conf.d/ssl/ca.crt \
                                      https://raw.githubusercontent.com/mikbill/distr/master/nginx/conf.d/ssl/ca.key
}

download_mysql (){
rm -Rf $dir_download/mysql
wget -P $dir_download/mysql https://raw.githubusercontent.com/mikbill/distr/master/mysql/my.cnf \
                            https://raw.githubusercontent.com/mikbill/distr/master/mysql/my-mikbill.cnf
wget -P $dir_download/mysql/base https://raw.githubusercontent.com/mikbill/distr/master/mysql/mikbill_2_0_6_utf8.sql \
                                https://raw.githubusercontent.com/mikbill/distr/master/mysql/mikbill_5.5.sql
}

download_control (){
wget -P $dir_download/control https://github.com/mikbill/distr/raw/master/control/start.sh
chmod +x $dir_download/start.sh
}

install_nginx (){
docker rm -f nginx
rm -Rf $dir_root/nginx
mkdir -p $dir_root/nginx/logs
cp -R $dir_download/nginx $dir_root

docker run -p 80:80 -p 443:443  -v $dir_root/nginx/nginx.conf:/etc/nginx/nginx.conf \
                                -v $dir_root/nginx/vhosts:/etc/nginx/conf.d \
                                -v $dir_root/nginx/logs:/var/log/nginx \
                                -v $dir_root/mikbill/www:/var/www/mikbill \
                                -v $dir_root/mikbill/php-socket:/var/run/ \
                                --name nginx -d nginx
}

install_mysql (){
docker rm -f mysql
rm -Rf $dir_root/mysql
mkdir -p $dir_root/mysql
cp -R $dir_download/mysql $dir_root

docker run -p 3306:3306 -v $dir_root/mysql/my.cnf:/etc/mysql/conf.d/my.cnf \
                        -v $dir_root/mysql/base:/var/lib/mysql \
                        --name mysql -e MYSQL_ROOT_PASSWORD=$mysql_root_passwd -d mysql:5.5
sed -i "s/MIKBILLPASS/$mysql_mikbill_passwd/g" $dir_root/mysql/base/mikbill_5.5.sql

sleep 20
docker exec mysql sh -c "exec mysql -uroot -p$mysql_root_passwd < /var/lib/mysql/mikbill_5.5.sql"
docker exec mysql sh -c "exec mysql -uroot -p$mysql_root_passwd mikbill < /var/lib/mysql/mikbill_2_0_6_utf8.sql"

docker stop mysql
rm $dir_root/mysql/my.cnf
mv $dir_root/mysql/my-mikbill.cnf $dir_root/mysql/my.cnf
rm -f $dir_root/mysql/base/ib_logfile0 $dir_root/mysql/base/ib_logfile1 $dir_root/mysql/base/ibdata1
docker start mysql
}

install_mikbill (){
docker rm -f mikbill
rm -Rf $dir_root/mikbill
mkdir -p $dir_root/mikbill/log/php-fpm
mkdir -p $dir_root/mikbill/php-socket
touch $dir_root/mikbill/log/mikbill.log
cp -R $dir_download/mikbill $dir_root
tar xzf $dir_root/mikbill/www/admin.tar.gz -C $dir_root/mikbill/www/
tar xzf $dir_root/mikbill/www/stat.tar.gz -C $dir_root/mikbill/www/
tar xzf $dir_root/mikbill/www/map.tar.gz -C $dir_root/mikbill/www/
rm -f $dir_root/mikbill/www/admin.tar.gz $dir_root/mikbill/www/stat.tar.gz $dir_root/mikbill/www/map.tar.gz

sed -i "s/MIKBILLPASS/$mysql_mikbill_passwd/g" $dir_root/mikbill/www/admin/app/etc/config.xml
sed -i "s/MIKBILLPASS/$mysql_mikbill_passwd/g" $dir_root/mikbill/www/stat/app/etc/config.xml
sed -i "s/MIKBILLPASS/$mysql_mikbill_passwd/g" $dir_root/mikbill/www/map/app/etc/config.xml

docker run -p 2007:2007 -v $dir_root/mikbill/www:/var/www/mikbill \
                        -v $dir_root/mikbill/www.conf:/etc/php-fpm.d/www.conf \
                        -v $dir_root/mikbill/crontab:/etc/crontab \
                        -v $dir_root/mikbill/log/:/var/log/ \
                        -v $dir_root/mikbill/php-socket:/var/run/php-socket \
                        -v $dir_root/mysql/base:/var/lib/mysql \
                        --name mikbill -d mikbill/mikbill
}

install_radius (){
docker rm -f radius
rm -Rf $dir_root/radius
mkdir -p $dir_root/radius/dictionary
cp -R $dir_download/radius $dir_root

docker run -p 1812:1812 -p 1813:1813 -p 67:67 -p 68:68  -v $dir_root/radius/radiusd.conf:/etc/raddb/radiusd.conf \
                                                        -v $dir_root/radius/sql.conf:/etc/raddb/sql.conf \
                                                        -v $dir_root/radius/dictionary:/usr/share/freeradius \
                                                        -v $dir_root/mysql/base/mysql.sock:/var/lib/mysql/mysql.sock \
                                                        --name radius -d mikbill/radius

sed -i "s/MIKBILLPASS/$mysql_mikbill_passwd/g" $dir_root/radius/sql.conf
docker exec radius sh -c "exec mv /tmp/freeradius/* /usr/share/freeradius/"
docker restart radius
}

install_control (){
mkdir -p $dir_root/control
cp $dir_install/control/start.sh $dir_root/control/start.sh
}

docker_clear (){
docker rm -f $(docker ps -a -q) && docker rmi -f $(docker images -q)
}

install_clear (){
rm -f $dir_base/mikbill_2_0_6_utf8.sql
rm -f $dir_base/mikbill_5.5.sql
rm -Rf $dir_download
}
# Установка docker
install_docker (){
if [ "$(rpm -qa |grep docker)" = "" ] ; then {
curl -sSL https://get.docker.com/ | sh 
/etc/init.d/docker start
} 
fi  
}
# Установка скрипта для свободных обновлений
download_update_free (){
wget -O $dir_download/mikbill/www/admin/sys/update/mikbill_update.sh https://github.com/mikbill/distr/raw/master/mikbill/update/mikbill_update.sh
chmod +x $dir_root/mikbill/www/admin/sys/update/mikbill_update.sh
}

