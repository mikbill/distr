#!/bin/bash
download_mikbill (){
mkdir -p $dir_install $dir_mikbill/dictionary
wget https://github.com/mikbill/distr/blob/master/host/admin.tar.gz?raw=true -O $dir_install/admin.tar.gz
wget https://github.com/mikbill/distr/blob/master/host/stat.tar.gz?raw=true -O $dir_install/stat.tar.gz
wget https://github.com/mikbill/distr/blob/master/host/map.tar.gz?raw=true -O $dir_install/map.tar.gz
wget https://raw.githubusercontent.com/mikbill/distr/master/mikbill/www.conf -O $dir_mikbill/www.conf
wget https://github.com/mikbill/distr/raw/master/mikbill/crontab -O $dir_mikbill/crontab
wget https://github.com/mikbill/distr/raw/master/mikbill/radiusd.conf -O $dir_mikbill/radiusd.conf
wget https://github.com/mikbill/distr/raw/master/mikbill/sql.conf -O $dir_mikbill/sql.conf

wget https://github.com/mikbill/distr/raw/master/mikbill/dictonary/dictionary -O $dir_mikbill/dictionary/dictionary
wget https://github.com/mikbill/distr/raw/master/mikbill/dictonary/dictionary.dhcp -O $dir_mikbill/dictionary/dictionary.dhcp
wget https://github.com/mikbill/distr/raw/master/mikbill/dictonary/dictionary.dlink -O $dir_mikbill/dictionary/dictionary.dlink
wget https://github.com/mikbill/distr/raw/master/mikbill/dictonary/dictionary.mikrotik -O $dir_mikbill/dictionary/dictionary.mikrotik
wget https://github.com/mikbill/distr/raw/master/mikbill/dictonary/dictionary.mpd -O $dir_mikbill/dictionary/dictionary.mpd
}

download_nginx (){
mkdir -p $dir_nginx_vhosts/ssl
wget https://raw.githubusercontent.com/mikbill/distr/master/nginx/nginx.conf -O $dir_nginx/nginx.conf
wget https://raw.githubusercontent.com/mikbill/distr/master/nginx/conf.d/00_stat_zaglushka_vhost.conf -O $dir_nginx_vhosts/00_stat_zaglushka_vhost.conf
wget https://raw.githubusercontent.com/mikbill/distr/master/nginx/conf.d/admin_vhost.conf -O $dir_nginx_vhosts/admin_vhost.conf
wget https://raw.githubusercontent.com/mikbill/distr/master/nginx/conf.d/map_vhost.conf -O $dir_nginx_vhosts/map_vhost.conf
wget https://raw.githubusercontent.com/mikbill/distr/master/nginx/conf.d/stat_vhost.conf -O $dir_nginx_vhosts/stat_vhost.conf
wget https://raw.githubusercontent.com/mikbill/distr/master/nginx/conf.d/ssl/ca.crt -O $dir_nginx_vhosts/ssl/ca.crt
wget https://raw.githubusercontent.com/mikbill/distr/master/nginx/conf.d/ssl/ca.key -O $dir_nginx_vhosts/ssl/ca.key
}

download_mysql (){
wget https://raw.githubusercontent.com/mikbill/distr/master/mysql/mikbill_2_0_6_utf8.sql -O $dir_install/mikbill_2_0_6_utf8.sql
wget https://raw.githubusercontent.com/mikbill/distr/master/mysql/mikbill_5.5.sql -O $dir_install/mikbill_5.5.sql 
wget https://raw.githubusercontent.com/mikbill/distr/master/mysql/my.cnf -O $dir_install/my.cnf
wget https://raw.githubusercontent.com/mikbill/distr/master/mysql/my-mikbill.cnf -O $dir_install/my-mikbill.cnf
}

install_nginx (){
docker rm -f nginx
mkdir -p $dir_mikbill_www
mkdir -p $dir_nginx_logs
docker run -p 80:80 -p 443:443 --name nginx -v $dir_nginx/nginx.conf:/etc/nginx/nginx.conf \
                                            -v $dir_nginx_vhosts:/etc/nginx/conf.d \
                                            -v $dir_mikbill_www:/var/www/mikbill \
                                            -v $dir_nginx_logs:/var/log/nginx \
                                            -v /var/run/php-worker-socket:/var/run/php-worker-socket \
                                            -d nginx
}
install_mysql (){
docker rm -f mysql
rm -Rf $dir_mysql
mkdir -p $dir_mysql_base
cp $dir_install/my.cnf $dir_mysql/my.cnf
cp $dir_install/mikbill_2_0_6_utf8.sql $dir_mysql_base/mikbill_2_0_6_utf8.sql 

docker run -p 3306:3306 -v $dir_mysql/my.cnf:/etc/mysql/conf.d/my.cnf \
                        -v $dir_mysql_base:/var/lib/mysql \
                        --name mysql -e MYSQL_ROOT_PASSWORD=$mysql_root_passwd -d mysql:5.5
sed -e "s/MIKBILLPASS/$mysql_mikbill_passwd/g" $dir_install/mikbill_5.5.sql > $dir_mysql_base/mikbill_5.5.sql

sleep 20
docker exec mysql sh -c "exec mysql -uroot -p$mysql_root_passwd < /var/lib/mysql/mikbill_5.5.sql"
docker exec mysql sh -c "exec mysql -uroot -p$mysql_root_passwd mikbill < /var/lib/mysql/mikbill_2_0_6_utf8.sql"

docker stop mysql
rm -f  $dir_mysql/my.cnf
cp $dir_install/my-mikbill.cnf $dir_mysql/my.cnf
rm -f $dir_mysql_base/ib_logfile0 $dir_mysql_base/ib_logfile1 $dir_mysql_base/ibdata1
docker start mysql
}

install_mikbill (){
docker rm -f mikbill

rm -Rf $dir_mikbill_www
mkdir -p $dir_mikkbill_www $dir_mikbill/log
tar xzf $dir_install/admin.tar.gz -C $dir_mikkbill_www
tar xzf $dir_install/stat.tar.gz -C $dir_mikkbill_www
tar xzf $dir_install/map.tar.gz -C $dir_mikkbill_www

docker run -p 1812:1812 -p 1813:1813 -p 67:67 -p 68:68 -p 2007:2007 \
          -v $dir_mikbill_www:/var/www/mikbill \
          -v $dir_mikbill/www.conf:/etc/php-fpm.d/www.conf \
          -v $dir_mikbill/crontab:/etc/crontab \
          -v $dir_mikbill/log/:/var/log/ \
          -v $dir_mikbill/radiusd.conf:/etc/raddb/radiusd.conf \
          -v $dir_mikbill/sql.conf:/etc/raddb/sql.conf \
          -v $dir_mikbill/dictionary:/usr/share/freeradius \
          --name mikbill -d mikbill/mikbill
}

docker_clear (){
docker rm -f $(docker ps -a -q) && docker rmi -f $(docker images -q)
}

install_clear (){
rm -f $dir_base/mikbill_2_0_6_utf8.sql
rm -f $dir_base/mikbill_5.5.sql
rm -Rf $dir_install
}
# Установка docker
install_docker (){
if [ "$(rpm -qa |grep docker)" = "" ] ; then {
curl -sSL https://get.docker.com/ | sh 
/etc/init.d/docker start
} 
fi  
}
